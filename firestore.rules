rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAnonymousUser() {
      return isSignedIn()
        && request.auth.token.firebase is map
        && request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    function isWhitelistedUid() {
      return isSignedIn()
        && request.auth.uid in [
          'CdP5YrCYW1d1RjqVQVbnm5QJCLV2',
          '7lGXb8XSW4NVSoIPWW8udn3tntK2',
        ];
    }

    function isTrustedUser() {
      return isSignedIn() && !isAnonymousUser() && isWhitelistedUid();
    }

    function isDemoSpace(spaceId) {
      return spaceId == 'template-demo-space';
    }

    function isAnonymousDemoAccess(spaceId) {
      return isAnonymousUser() && isDemoSpace(spaceId);
    }

    function spacePath(appId, spaceId) {
      return /databases/$(database)/documents/artifacts/$(appId)/spaces/$(spaceId);
    }

    function isSpaceMember(appId, spaceId) {
      return isAnonymousDemoAccess(spaceId)
        || (
          isTrustedUser()
          && request.auth.uid in get(spacePath(appId, spaceId)).data.members
        );
    }

    function isValidWatchlistStatus(status) {
      return status == 'unwatched'
        || status == 'watching'
        || status == 'watched';
    }

    function isValidCatalogData(data, mediaId) {
      return data.mediaId is string
        && data.mediaId == mediaId
        && data.source is map
        && data.media is map
        && data.title is string
        && data.type is string;
    }

    function isValidWatchlistData(data, mediaId) {
      return data.mediaId is string
        && data.mediaId == mediaId
        && data.addedBy is string
        && data.userState is map
        && isValidWatchlistStatus(data.status)
        && isValidWatchlistStatus(data.userState.status);
    }

    function isValidWatchlistCreate(data, mediaId) {
      return data.addedBy == request.auth.uid
        && isValidWatchlistData(data, mediaId);
    }

    function isValidWatchlistUpdate(mediaId) {
      return request.resource.data.addedBy == resource.data.addedBy
        && isValidWatchlistData(request.resource.data, mediaId);
    }

    // Space documents
    match /artifacts/{appId}/spaces/{spaceId} {
      allow read: if isAnonymousDemoAccess(spaceId)
        || (
          isTrustedUser()
          && request.auth.uid in resource.data.members
        );

      allow create: if isTrustedUser()
        && request.resource.data.name is string
        && request.resource.data.nameLower is string
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.members is list
        && request.resource.data.members.size() == 1
        && request.resource.data.members.hasAny([request.auth.uid]);

      // Allow adding self to members (idempotent)
      allow update: if isTrustedUser()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['members', 'updatedAt'])
        && request.resource.data.members is list
        && request.resource.data.members.hasAny([request.auth.uid])
        && (
          (
            request.resource.data.members.size() == resource.data.members.size() + 1
            && request.resource.data.members.hasAll(resource.data.members)
          )
          || (
            request.resource.data.members.size() == resource.data.members.size()
            && request.resource.data.members.hasAll(resource.data.members)
          )
        );

      allow delete: if false;
    }

    // Shared media catalog
    match /artifacts/{appId}/media_catalog/{mediaId} {
      allow read: if isTrustedUser();
      allow create, update: if isTrustedUser() && isValidCatalogData(request.resource.data, mediaId);
      allow delete: if false;
    }

    // Watchlist items: only space members can read/write
    match /artifacts/{appId}/spaces/{spaceId}/watchlist_items/{itemId} {
      allow read: if isSpaceMember(appId, spaceId);
      allow create: if isSpaceMember(appId, spaceId)
        && isValidWatchlistCreate(request.resource.data, itemId);
      allow update: if isSpaceMember(appId, spaceId)
        && isValidWatchlistUpdate(itemId);
      allow delete: if isSpaceMember(appId, spaceId);
    }

    // Default deny for everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
